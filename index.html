<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ISKCON Master Studio 2.0</title>
    
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Teko:wght@500&display=swap" rel="stylesheet">

    <style>
        /* --- CORE THEME --- */
        :root {
            --primary: #FF9933; 
            --primary-glow: rgba(255, 153, 51, 0.4);
            --danger: #ff4757; 
            --success: #2ed573;
            --bg-dark: #050505; 
            --panel-bg: #141414;
            --border: #2a2a2a; 
            --text-main: #ffffff;
            --surface: #1f1f1f;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: 'Manrope', sans-serif; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- NOTIFICATIONS (TOAST) --- */
        #toast-container { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); color: white; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border); font-size: 0.9rem; animation: fadeUp 0.3s ease forwards; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN --- */
        #login-section { position: absolute; inset: 0; z-index: 2000; background: radial-gradient(circle, #2e1a05, #000); display: flex; justify-content: center; align-items: center; }
        .login-card { background: rgba(20,20,20,0.8); backdrop-filter: blur(20px); border: 1px solid var(--border); padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .brand-lg { font-size: 1.5rem; color: var(--primary); font-weight: 800; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .custom-inp { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid var(--border); border-radius: 12px; color: white; text-align: center; font-size: 1rem; transition: 0.3s; }
        .custom-inp:focus { border-color: var(--primary); }
        .btn-master { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 1rem; cursor: pointer; transition: transform 0.2s; box-shadow: 0 5px 20px var(--primary-glow); }
        .btn-master:active { transform: scale(0.98); }

        /* --- MAIN UI --- */
        #admin-section { display: none; height: 100%; width: 100%; }
        .dashboard-grid { display: grid; height: 100%; width: 100%; grid-template-rows: auto 1fr auto; }

        /* HEADER */
        .header { padding: 15px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .logo-area { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1rem; color: #ddd; }
        .logo-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; box-shadow: 0 0 5px #555; }
        
        .is-live .logo-dot { background: red; box-shadow: 0 0 10px red; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .viewer-box { display: flex; align-items: center; gap: 8px; background: #000; padding: 4px 12px; border-radius: 20px; border: 1px solid #333; }
        .eye-icon { color: #888; font-size: 0.8rem; }
        .is-live .eye-icon { color: red; }
        .count-txt { font-family: 'Teko', sans-serif; font-size: 1.4rem; line-height: 1; color: white; position: relative; top: 1px; }

        .btn-icon { background: rgba(255,255,255,0.05); width: 35px; height: 35px; border-radius: 50%; display: grid; place-items: center; border: none; color: #aaa; cursor: pointer; transition: 0.2s; margin-left: 8px; }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }
        .btn-icon.active { background: var(--primary); color: white; }

        /* STAGE (VIDEO) */
        .stage { background: #000; position: relative; overflow: hidden; width: 100%; height: 100%; display: grid; place-items: center; }
        #local-player { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* Mirror effect for self view */
        .mic-muted-overlay { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: var(--danger); padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 0.8rem; display: none; backdrop-filter: blur(5px); }

        /* DECK (CONTROLS) */
        .deck { background: var(--panel-bg); border-top: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        .server-line { display: flex; gap: 10px; align-items: center; }
        .server-select { flex: 1; background: #000; color: #ccc; border: 1px solid var(--border); padding: 12px; border-radius: 12px; font-size: 0.9rem; text-align: center; appearance: none; font-weight: 600; }
        .signal-indicator { width: 40px; height: 40px; border-radius: 10px; background: #111; border: 1px solid #333; display: grid; place-items: center; color: #444; }
        .signal-indicator.live { color: var(--success); border-color: var(--success); box-shadow: 0 0 10px rgba(46, 213, 115, 0.2); }

        .control-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; }
        
        .btn-sq { height: 60px; border-radius: 18px; border: 1px solid var(--border); background: var(--surface); color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .btn-sq:active { transform: scale(0.95); }
        .btn-sq.off { background: rgba(255, 71, 87, 0.15); border-color: var(--danger); color: var(--danger); }
        .btn-sq.off i { position: relative; }
        
        .btn-main { height: 60px; border-radius: 18px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 1.1rem; box-shadow: 0 4px 15px var(--primary-glow); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; letter-spacing: 0.5px; }
        .btn-main.live-active { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); animation: breathe 3s infinite ease-in-out; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }

        /* DESKTOP LAYOUT */
        @media (min-width: 768px) {
            .dashboard-grid { grid-template-rows: 65px 1fr; grid-template-columns: 1fr 400px; }
            .header { grid-column: 1 / -1; grid-row: 1; border-bottom: 1px solid var(--border); }
            .stage { grid-column: 1; grid-row: 2; border-right: 1px solid var(--border); }
            .deck { grid-column: 2; grid-row: 2; border-top: none; justify-content: center; align-items: center; background: #0e0e0e; }
            .server-line, .control-row { width: 100%; max-width: 320px; }
            .btn-sq:hover { background: #333; }
        }

        /* --- MODAL --- */
        .modal-wrap { position: absolute; inset: 0; z-index: 3000; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-wrap.open { opacity: 1; pointer-events: all; }
        .modal-card { background: #1a1a1a; width: 95%; max-width: 500px; max-height: 85%; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px black; }
        .m-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #141414; }
        .m-body { padding: 20px; overflow-y: auto; flex: 1; }
        .id-input-group { margin-bottom: 15px; }
        .id-lbl { font-size: 0.75rem; color: var(--primary); font-weight: 700; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .id-field { width: 100%; background: #050505; border: 1px solid #333; color: #ddd; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; }
        .id-field:focus { border-color: var(--primary); }
        .m-foot { padding: 15px 20px; border-top: 1px solid var(--border); text-align: right; background: #141414; }
        .btn-save { background: var(--success); color: #000; border: none; padding: 10px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN -->
    <div id="login-section">
        <div class="login-card">
            <div class="brand-lg"><i class="fas fa-om"></i> ISKCON STUDIO</div>
            <input type="email" id="email" class="custom-inp" placeholder="Admin Email" autocomplete="email">
            <input type="password" id="password" class="custom-inp" placeholder="Secure Password">
            <button id="loginBtn" class="btn-master" onclick="Auth.login()">ACCESS STUDIO</button>
        </div>
    </div>

    <!-- ADMIN INTERFACE -->
    <div id="admin-section">
        <div class="dashboard-grid">
            <div class="header">
                <div class="logo-area">
                    <div class="logo-dot"></div>
                    <span>ISKCON STUDIO</span>
                </div>
                
                <div style="display:flex; align-items:center;">
                    <div class="viewer-box">
                        <i class="fas fa-eye eye-icon"></i>
                        <span id="viewerCount" class="count-txt">0</span>
                    </div>

                    <button class="btn-icon" onclick="Settings.open()" title="Settings"><i class="fas fa-sliders-h"></i></button>
                    <button class="btn-icon" onclick="Auth.logout()"><i class="fas fa-power-off"></i></button>
                </div>
            </div>

            <!-- VIDEO AREA -->
            <div class="stage">
                <div class="mic-muted-overlay" id="muteOverlay"><i class="fas fa-microphone-slash"></i> MIC OFF</div>
                <div id="local-player"></div>
            </div>

            <!-- CONTROLS -->
            <div class="deck">
                <div class="server-line">
                    <div class="signal-indicator" id="signalLight"><i class="fas fa-wifi"></i></div>
                    <select id="serverSelector" class="server-select" onchange="Stream.handleServerSwitch(this.value)">
                        <option value="0">Server 01 (Main Hall)</option>
                        <option value="1">Server 02 (Altar)</option>
                        <option value="2">Server 03 (Backup 1)</option>
                        <option value="3">Server 04 (Backup 2)</option>
                        <option value="4">Server 05 (Event)</option>
                        <option value="5">Server 06 (Ext)</option>
                        <option value="6">Server 07 (Mobile)</option>
                    </select>
                </div>

                <div class="control-row">
                    <!-- MIC -->
                    <button class="btn-sq" id="btnMic" onclick="Hardware.toggleMic()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <!-- STREAM BTN -->
                    <button class="btn-main" id="streamBtn" onclick="Stream.toggle()">
                        <i class="fas fa-broadcast-tower"></i> <span>GO LIVE</span>
                    </button>
                    
                    <!-- CAM SWITCH -->
                    <button class="btn-sq" id="btnCam" onclick="Hardware.switchCamera()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div style="text-align:center; font-size:0.7rem; color:#444;">ISKCON HADAPSAR BROADCAST UNIT</div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-wrap">
        <div class="modal-card">
            <div class="m-head">
                <span style="font-weight:bold; color:white;">Configure Channels</span>
                <button class="btn-icon" onclick="Settings.close()"><i class="fas fa-times"></i></button>
            </div>
            <div class="m-body" id="ids-container">
                <!-- Inputs injected via JS -->
            </div>
            <div class="m-foot">
                <button class="btn-save" onclick="Settings.save()">SAVE CHANGES</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & AGORA -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- 1. CONFIGURATION ---
        const FB_CONFIG = {
            apiKey: "AIzaSyBfbNzASqzPt4kMP-LlpJasIras7ifTch4",
            authDomain: "iskcon-hadapsar.firebaseapp.com",
            databaseURL: "https://iskcon-hadapsar-default-rtdb.firebaseio.com",
            projectId: "iskcon-hadapsar",
            appId: "1:231589086724:web:64d8a5d7a136b39db39751"
        };

        const app = initializeApp(FB_CONFIG);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // State Management
        const State = {
            client: null,
            tracks: { video: null, audio: null },
            isLive: false,
            micOn: true,
            agoraIds: [],
            availableCams: [],
            currentCamIdx: 0
        };

        // --- 2. UTILS ---
        window.Toast = (msg, type='info') => {
            const el = document.createElement('div');
            el.className = 'toast';
            let icon = type === 'error' ? '<i class="fas fa-exclamation-circle" style="color:#ff4757"></i>' : 
                       type === 'success' ? '<i class="fas fa-check-circle" style="color:#2ed573"></i>' : 
                       '<i class="fas fa-info-circle" style="color:#1e90ff"></i>';
            el.innerHTML = `${icon} <span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        };

        // --- 3. AUTH MODULE ---
        window.Auth = {
            login: () => {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                if(!e || !p) return Toast("Please fill credentials", "error");
                
                document.getElementById('loginBtn').innerText = 'VERIFYING...';
                signInWithEmailAndPassword(auth, e, p)
                    .then(() => Toast("Access Granted", "success"))
                    .catch(err => {
                        document.getElementById('loginBtn').innerText = 'ACCESS STUDIO';
                        Toast("Auth Failed: " + err.message, "error");
                    });
            },
            logout: () => {
                if(confirm("Confirm Exit Studio?")) {
                    if(State.isLive) Stream.stop(); 
                    signOut(auth);
                }
            }
        };

        onAuthStateChanged(auth, u => {
            document.getElementById('login-section').style.display = u ? 'none' : 'flex';
            const adminPanel = document.getElementById('admin-section');
            if(u) {
                adminPanel.style.display = 'block';
                Hardware.init();
                Settings.fetch();
                // Monitor Viewer Count
                onValue(ref(db, 'viewers'), s => document.getElementById('viewerCount').innerText = s.size);
            } else {
                adminPanel.style.display = 'none';
            }
        });

        // --- 4. HARDWARE MODULE ---
        window.Hardware = {
            init: async () => {
                try {
                    // Create Tracks
                    [State.tracks.audio, State.tracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks(
                        { encoderConfig: "high_quality_stereo" }, 
                        { encoderConfig: "720p_2" }
                    );
                    
                    State.tracks.video.play("local-player");
                    
                    // Get Camera List for switching
                    const devices = await AgoraRTC.getDevices();
                    State.availableCams = devices.filter(d => d.kind === "videoinput");
                    
                    // Update Icons
                    Hardware.updateIcons();
                } catch(e) {
                    Toast("Hardware Error: Allow Camera/Mic permissions", "error");
                    console.error(e);
                }
            },
            toggleMic: () => {
                if(!State.tracks.audio) return;
                State.micOn = !State.micOn;
                State.tracks.audio.setEnabled(State.micOn);
                Hardware.updateIcons();
                Toast(State.micOn ? "Microphone Active" : "Microphone Muted", State.micOn ? "success" : "error");
            },
            switchCamera: async () => {
                if(!State.tracks.video || State.availableCams.length < 2) {
                    return Toast("Only one camera detected", "error");
                }
                const btn = document.getElementById('btnCam');
                btn.disabled = true; // Prevent spam

                // Cycle Index
                State.currentCamIdx = (State.currentCamIdx + 1) % State.availableCams.length;
                const nextId = State.availableCams[State.currentCamIdx].deviceId;

                try {
                    State.tracks.video.setDevice(nextId); // setDevice is smoother than recreating track
                    Toast("Switched Camera");
                } catch(e) {
                    Toast("Camera Switch Failed", "error");
                }
                btn.disabled = false;
            },
            updateIcons: () => {
                const mBtn = document.getElementById('btnMic');
                const overlay = document.getElementById('muteOverlay');
                
                if(State.micOn) {
                    mBtn.classList.remove('off');
                    mBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    overlay.style.display = 'none';
                } else {
                    mBtn.classList.add('off');
                    mBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    overlay.style.display = 'block';
                }
            }
        };

        // --- 5. STREAMING MODULE ---
        window.Stream = {
            toggle: async () => {
                if (State.isLive) await Stream.stop();
                else await Stream.start();
            },
            start: async () => {
                const sIdx = document.getElementById('serverSelector').value;
                const appId = State.agoraIds[sIdx];
                
                if(!appId || appId.length < 5) return Toast("Invalid App ID for this Server", "error");

                document.getElementById('streamBtn').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> STARTING';
                
                try {
                    State.client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
                    await State.client.setClientRole("host");
                    
                    await State.client.join(appId, "iskcon_live", null, null);
                    await State.client.publish([State.tracks.video, State.tracks.audio]);

                    // Sync to Firebase
                    await set(ref(db, 'live_status'), { isLive: true, serverIndex: parseInt(sIdx) });

                    State.isLive = true;
                    Stream.updateUI(true);
                    Toast("ðŸ”´ YOU ARE LIVE NOW!", "success");

                } catch(e) {
                    console.error(e);
                    Toast("Connection Error: " + e.message, "error");
                    document.getElementById('streamBtn').innerHTML = '<i class="fas fa-broadcast-tower"></i> GO LIVE';
                }
            },
            stop: async () => {
                if(!confirm("End Broadcast? Viewers will be disconnected.")) return;
                
                try {
                    State.client.leave();
                    await set(ref(db, 'live_status'), { isLive: false, serverIndex: 0 });
                    
                    State.isLive = false;
                    Stream.updateUI(false);
                    Toast("Broadcast Ended");
                } catch(e) {
                    console.error(e);
                }
            },
            handleServerSwitch: async (val) => {
                if(State.isLive) {
                    if(confirm("Live Stream will restart on new Server. Confirm?")) {
                        await Stream.stop();
                        // Small delay for cleanup
                        setTimeout(() => Stream.start(), 1000);
                    } else {
                        // Revert select if cancelled (needs logic but keeping simple for now)
                    }
                }
            },
            updateUI: (live) => {
                const btn = document.getElementById('streamBtn');
                const signal = document.getElementById('signalLight');
                const body = document.body;

                if(live) {
                    body.classList.add('is-live');
                    btn.classList.add('live-active');
                    btn.innerHTML = '<i class="fas fa-square"></i> STOP LIVE';
                    signal.classList.add('live');
                } else {
                    body.classList.remove('is-live');
                    btn.classList.remove('live-active');
                    btn.innerHTML = '<i class="fas fa-broadcast-tower"></i> GO LIVE';
                    signal.classList.remove('live');
                }
            }
        };

        // --- 6. SETTINGS MODULE ---
        window.Settings = {
            fetch: () => {
                onValue(ref(db, 'config/agora_ids'), s => {
                    const data = s.val();
                    State.agoraIds = Array.isArray(data) ? data : Array(7).fill("");
                });
            },
            open: () => {
                const div = document.getElementById('ids-container');
                div.innerHTML = "";
                State.agoraIds.forEach((id, i) => {
                    div.innerHTML += `
                        <div class="id-input-group">
                            <label class="id-lbl">Server ${i+1} ID</label>
                            <input type="text" id="sid_${i}" class="id-field" value="${id || ''}" placeholder="Paste Agora App ID">
                        </div>
                    `;
                });
                const modal = document.getElementById('settings-modal');
                modal.style.display = 'flex';
                setTimeout(()=> modal.classList.add('open'), 10);
            },
            close: () => {
                const modal = document.getElementById('settings-modal');
                modal.classList.remove('open');
                setTimeout(()=> modal.style.display = 'none', 300);
            },
            save: async () => {
                const newIds = [];
                for(let i=0; i<7; i++) {
                    newIds.push(document.getElementById(`sid_${i}`).value.trim());
                }
                await set(ref(db, 'config/agora_ids'), newIds);
                Toast("Server Config Saved", "success");
                Settings.close();
            }
        };

        // Check for dirty close
        window.addEventListener("beforeunload", (e) => {
            if (State.isLive) {
                // Attempt to flag offline
                 set(ref(db, 'live_status'), { isLive: false });
            }
        });
    </script>
</body>
</html>
