<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ISKCON Admin | Master Studio</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;800&family=Teko:wght@400&display=swap" rel="stylesheet">

    <style>
        /* DARK PRO THEME */
        :root { --primary: #FF9933; --bg: #050505; --panel: #141414; --danger: #eb4d4b; --success: #2ed573; --border: #2a2a2a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Manrope', sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* UI COMPONENTS */
        .toast { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border); box-shadow: 0 5px 20px black; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; display: flex; gap: 10px; align-items: center; white-space: nowrap; }
        @keyframes popUp { from{transform:translate(-50%, 20px); opacity:0;} to{transform:translate(-50%,0); opacity:1;} }

        /* LAYOUT */
        .header { height: 60px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .brand { color: var(--primary); font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .brand-dot { width: 10px; height: 10px; background: #333; border-radius: 50%; }
        body.is-live .brand-dot { background: var(--danger); box-shadow: 0 0 10px var(--danger); animation: pulse 1s infinite; }
        
        .stage { flex: 1; background: black; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        #local-player { width: 100%; height: 100%; object-fit: cover; }
        
        .mute-overlay { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: var(--danger); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--danger); font-size: 0.8rem; font-weight: 800; display: none; }
        
        /* CONTROLS */
        .deck { background: var(--panel); padding: 20px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        .server-wrap { display: flex; gap: 10px; background: #000; padding: 5px; border-radius: 12px; border: 1px solid var(--border); }
        .server-status { width: 45px; display: grid; place-items: center; border-radius: 8px; background: #111; color: #444; transition: 0.3s; }
        .server-status.on { background: rgba(46, 213, 115, 0.15); color: var(--success); box-shadow: inset 0 0 10px rgba(46, 213, 115, 0.1); }
        .server-select { flex: 1; background: none; border: none; color: white; padding: 10px; font-weight: 600; text-align: center; }

        .btn-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 12px; height: 65px; }
        
        button { border: none; border-radius: 16px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; position: relative; overflow: hidden; }
        button:active { transform: scale(0.96); }

        .btn-sq { background: #1e1e1e; color: #ddd; border: 1px solid var(--border); }
        .btn-sq.mic-off { background: rgba(235, 77, 75, 0.15); border-color: var(--danger); color: var(--danger); }
        
        .btn-main { background: var(--primary); color: #000; font-weight: 800; font-family: 'Teko', sans-serif; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3); letter-spacing: 1px; }
        .btn-main.stop { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(235, 77, 75, 0.4); }

        /* MODAL */
        #settings-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .s-card { background: #141414; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); }
        .s-inp { width: 100%; background: black; border: 1px solid #333; padding: 12px; color: white; border-radius: 8px; margin-bottom: 10px; }
        
        /* VIEWER COUNT */
        .viewer-pill { background: #222; padding: 5px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; border: 1px solid #333; font-family: 'Teko', sans-serif; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- MAIN UI -->
    <div class="header">
        <div class="brand">
            <div class="brand-dot"></div> ISKCON STUDIO
        </div>
        <div style="display:flex; gap:10px;">
            <div class="viewer-pill"><i class="fas fa-eye" style="color:#aaa;"></i> <span id="viewCount">0</span></div>
            <button class="btn-sq" style="width:40px; height:40px; border-radius:50%; font-size:1rem;" onclick="openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="stage">
        <div id="local-player"></div>
        <div class="mute-overlay" id="muteTag"><i class="fas fa-microphone-slash"></i> MIC OFF</div>
    </div>

    <div class="deck">
        <div class="server-wrap">
            <div class="server-status" id="serverIcon"><i class="fas fa-wifi"></i></div>
            <select id="serverSelect" class="server-select" onchange="switchServerContext()">
                <option value="0">Server 01 (Main)</option>
                <option value="1">Server 02</option>
                <option value="2">Server 03</option>
                <option value="3">Server 04</option>
                <option value="4">Server 05</option>
            </select>
        </div>

        <div class="btn-row">
            <button id="micBtn" class="btn-sq" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button id="liveBtn" class="btn-main" onclick="toggleLive()">GO LIVE</button>
            <button id="camBtn" class="btn-sq" onclick="switchCamera()"><i class="fas fa-sync"></i></button>
        </div>
        <div style="text-align: center; color: #444; font-size: 0.75rem;">RADHA VRINDAVANCHANDRA LIVE CONTROL</div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-modal">
        <div class="s-card">
            <h3 style="color:white; margin-top:0;">Agora Setup</h3>
            <div id="idInputs"></div>
            <button class="btn-main" style="width:100%; height:50px; font-size:1.2rem;" onclick="saveConfig()">SAVE & EXIT</button>
        </div>
    </div>

    <!-- LIBS -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const FB_CFG = { apiKey: "AIzaSyBfbNzASqzPt4kMP-LlpJasIras7ifTch4", authDomain: "iskcon-hadapsar.firebaseapp.com", databaseURL: "https://iskcon-hadapsar-default-rtdb.firebaseio.com", projectId: "iskcon-hadapsar", appId: "1:231589086724:web:64d8a5d7a136b39db39751" };
        const app = initializeApp(FB_CFG);
        const db = getDatabase(app);

        // GLOBAL STATE
        const State = {
            client: AgoraRTC.createClient({ mode: "live", codec: "h264" }), // H264 is better for older phones compatibility
            localAudio: null,
            localVideo: null,
            isLive: false,
            isMuted: false,
            serverIndex: 0,
            cameras: [],
            camIdx: 0,
            agoraIds: []
        };

        // --- 1. INITIALIZATION ---
        async function init() {
            try {
                // Get hardware early
                [State.localAudio, State.localVideo] = await AgoraRTC.createMicrophoneAndCameraTracks(
                    { encoderConfig: "music_standard" }, // High quality audio
                    { encoderConfig: "720p_2" }          // Smooth Video
                );
                
                State.localVideo.play("local-player");
                
                // Get Cameras
                const devices = await AgoraRTC.getDevices();
                State.cameras = devices.filter(d => d.kind === "videoinput");
                
                // Listen for viewer count
                onValue(ref(db, 'viewers'), s => document.getElementById('viewCount').innerText = s.size);
                
                // Fetch IDs
                onValue(ref(db, 'config/agora_ids'), s => State.agoraIds = s.val() || []);
            } catch(e) { showToast("Camera/Mic Permission Denied!", true); }
        }
        init();

        // --- 2. LIVE LOGIC ---
        window.toggleLive = async () => {
            if(State.isLive) {
                // STOP
                if(!confirm("Stop Live Darshan?")) return;
                try {
                    await State.client.leave();
                    updateUI(false);
                    // Update Firebase
                    await update(ref(db, 'live_status'), { isLive: false, muted: false });
                    showToast("Broadcast Ended");
                } catch(e) { console.log(e); }
            } else {
                // START
                const sIdx = document.getElementById('serverSelect').value;
                const appId = State.agoraIds[sIdx];
                if(!appId) return showToast("Enter App ID in Settings!", true);

                try {
                    showToast("Starting Server connection...");
                    document.getElementById('liveBtn').innerText = "...";
                    
                    await State.client.setClientRole("host");
                    await State.client.join(appId, "iskcon_live", null, null);
                    await State.client.publish([State.localVideo, State.localAudio]);
                    
                    updateUI(true);
                    State.serverIndex = parseInt(sIdx);

                    // ATOMIC UPDATE FOR SYNC
                    await set(ref(db, 'live_status'), {
                        isLive: true,
                        serverIndex: State.serverIndex,
                        muted: State.isMuted // Send current mic state immediately
                    });
                    
                    // Safety: Disconnect handler
                    onDisconnect(ref(db, 'live_status')).set({ isLive: false });

                    showToast("You are LIVE! Hare Krishna.");
                } catch(e) {
                    showToast("Connection Error: " + e.code, true);
                    updateUI(false);
                }
            }
        };

        // --- 3. INSTANT CONTROLS ---
        window.toggleMic = () => {
            if(!State.localAudio) return;
            
            State.isMuted = !State.isMuted;
            State.localAudio.setEnabled(!State.isMuted); // Actual Hardware Toggle
            
            // FIREBASE SIGNAL (Instantly tells viewers)
            if(State.isLive) {
                update(ref(db, 'live_status'), { muted: State.isMuted });
            }
            
            // UI Update
            const btn = document.getElementById('micBtn');
            const overlay = document.getElementById('muteTag');
            
            if(State.isMuted) {
                btn.classList.add('mic-off');
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                overlay.style.display = 'block';
                showToast("Audio Muted for Everyone", true);
            } else {
                btn.classList.remove('mic-off');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                overlay.style.display = 'none';
                showToast("Audio Resumed");
            }
        };

        window.switchCamera = async () => {
            if(State.cameras.length < 2) return showToast("Only 1 Camera Found", true);
            
            const btn = document.getElementById('camBtn');
            btn.disabled = true; // prevent spam

            // Cycle logic
            State.camIdx = (State.camIdx + 1) % State.cameras.length;
            const nextDeviceId = State.cameras[State.camIdx].deviceId;

            try {
                showToast("Switching Lens...");
                // HOT SWITCH (Does not disconnect stream)
                await State.localVideo.setDevice(nextDeviceId);
            } catch(e) {
                showToast("Switch Failed: " + e.message, true);
            }
            btn.disabled = false;
        };

        // --- UTILS ---
        function updateUI(live) {
            State.isLive = live;
            const btn = document.getElementById('liveBtn');
            const status = document.getElementById('serverIcon');
            const body = document.body;

            if(live) {
                body.classList.add('is-live');
                btn.classList.add('stop');
                btn.innerHTML = "STOP LIVE";
                status.classList.add('on');
            } else {
                body.classList.remove('is-live');
                btn.classList.remove('stop');
                btn.innerHTML = "GO LIVE";
                status.classList.remove('on');
            }
        }

        window.openSettings = () => {
            const div = document.getElementById('idInputs');
            div.innerHTML = '';
            for(let i=0; i<5; i++) {
                div.innerHTML += `<input class="s-inp" id="id_${i}" placeholder="Server ${i+1} ID" value="${State.agoraIds[i]||''}">`;
            }
            document.getElementById('settings-modal').style.display = 'flex';
        };

        window.saveConfig = async () => {
            const arr = [];
            for(let i=0; i<5; i++) arr.push(document.getElementById(`id_${i}`).value.trim());
            await set(ref(db, 'config/agora_ids'), arr);
            document.getElementById('settings-modal').style.display = 'none';
        };

        function showToast(msg, isErr=false) {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.style.border = isErr ? '1px solid #eb4d4b' : '1px solid #2ed573';
            el.innerHTML = `${isErr ? '<i class="fas fa-exclamation"></i>' : '<i class="fas fa-check"></i>'} ${msg}`;
            c.appendChild(el);
            setTimeout(()=> el.remove(), 3000);
        }

        // --- Prevent accidental closure ---
        window.onbeforeunload = () => { if(State.isLive) return "Live stream is active!"; };
    </script>
</body>
</html>
